<section class="container-wrapper">
  <header class="header">
    <h2>Transações</h2>
    <app-user-menu [username]="'Admin Sistema'" [email]="'admin@sistema.com'" [saldo]="0" [saldoProtesto]="0">
    </app-user-menu>
  </header>

  <div class="metrics-grid">
    <app-summary-card class="width-max" title="Total de Transações" [value]="fmt(metrics.totalTransactions, 'int')"
      icon="pi pi-receipt" delta="+8.3%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Faturamento Total" [value]="fmt(metrics.totalVolume, 'currency', 0, 0)"
      icon="pi pi-dollar" delta="+12.5%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Reembolsos Totais"
      [value]="fmt(metrics.totalCommissions, 'currency', 0, 0)" icon="pi pi-coins" delta="+15.2%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Ticket Médio" [value]="fmt(metrics.averageTicket, 'currency', 0, 0)"
      icon="pi pi-chart-line" delta="+5.7%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Taxa de Conversão" [value]="fmt(metrics.conversionRate, 'percent', 1, 1)"
      icon="pi pi-percentage" delta="+2.1%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Taxa de Aprovação" [value]="fmt(metrics.approvalRate, 'percent', 1, 1)"
      icon="pi pi-check-circle" delta="+1.8%" deltaType="up">
    </app-summary-card>
  </div>

  <app-filter-tabs [tabs]="[
        { label: 'Todas',        value: '' },
        { label: 'Concluídas',   value: 'COMPLETED' },
        { label: 'Pendentes',    value: 'PENDING' },
        { label: 'Falharam',     value: 'FAILED' },
        { label: 'Canceladas',   value: 'CANCELLED' }
      ]" [selected]="filters.status" (selectedChange)="setStatus($event)" [search]="filters.search"
    (searchChange)="filters.search = $event; applyFilters()" searchPlaceholder="Buscar transação, parceiro ou cliente…"
    (export)="exportCSV()" (filterClick)="sidebarVisible = true">
  </app-filter-tabs>

  <div class="table-card">
    <div class="table-scroll">
      <table class="transactions-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Parceiro/Marca</th>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Valor</th>
            <th>Taxa</th>
            <th>Líquido</th>
            <th>Status</th>
            <th>Data</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let transaction of paginatedTransactions">
            <td>{{ transaction.id }}</td>
            <td>
              <div class="partner-info">
                <span class="name">{{ transaction.partnerName }}</span>
                <small class="brand">{{ transaction.brandName }}</small>
              </div>
            </td>
            <td>
              <div class="customer-info">
                <span class="name">{{ transaction.customerName || 'N/A' }}</span>
                <small class="email">{{ transaction.customerEmail }}</small>
              </div>
            </td>
            <td>
              <span class="tag type-tag">{{ getTypeLabel(transaction.transactionType) }}</span>
            </td>
            <td>{{ fmt(transaction.amount, 'currency', 0, 0) }}</td>
            <td>{{ fmt(transaction.fee, 'currency', 0, 0) }}</td>
            <td>{{ fmt(transaction.netAmount, 'currency', 0, 0) }}</td>
            <td>
              <span class="tag" [ngClass]="getStatusClass(transaction.status)">
                {{ getStatusLabel(transaction.status) }}
              </span>
            </td>
            <td>{{ transaction.createdAt | date:'dd/MM/yyyy HH:mm' }}</td>
            <td>
              <button class="btn-action" (click)="viewDetails(transaction)">
                <i class="pi pi-eye"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
        <i class="pi pi-chevron-left"></i>
      </button>

      <span class="page-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
        <i class="pi pi-chevron-right"></i>
      </button>
    </div>
  </div>

  <app-sidebar-filters [(visible)]="sidebarVisible" width="360px">
    <h3 header>Filtros de Transações</h3>

    <section class="drawer-content no-scrollbar">
      <div class="field">
        <span class="caption">ID/Parceiro/Cliente</span>
        <input type="text" [(ngModel)]="filters.search" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Status</span>
        <select [(ngModel)]="filters.status" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="COMPLETED">Concluída</option>
          <option value="PENDING">Pendente</option>
          <option value="FAILED">Falhou</option>
          <option value="CANCELLED">Cancelada</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Tipo de Transação</span>
        <select [(ngModel)]="filters.transactionType" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="PIX">PIX</option>
          <option value="CREDIT_CARD">Cartão de Crédito</option>
          <option value="DEBIT_CARD">Cartão de Débito</option>
          <option value="BOLETO">Boleto</option>
          <option value="TRANSFER">Transferência</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Parceiro</span>
        <input type="text" [(ngModel)]="filters.partnerName" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Marca</span>
        <input type="text" [(ngModel)]="filters.brandName" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Adquirente</span>
        <select [(ngModel)]="filters.acquirer" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="Stone">Stone</option>
          <option value="Cielo">Cielo</option>
          <option value="Rede">Rede</option>
          <option value="PagSeguro">PagSeguro</option>
          <option value="Mercado Pago">Mercado Pago</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Valor mínimo</span>
        <input type="number" [(ngModel)]="filters.minAmount" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Valor máximo</span>
        <input type="number" [(ngModel)]="filters.maxAmount" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Período</span>
        <select [(ngModel)]="filters.period" (change)="applyFilters()">
          <option value="all">Todos</option>
          <option value="today">Hoje</option>
          <option value="week">Últimos 7 dias</option>
          <option value="month">Este mês</option>
          <option value="quarter">Este trimestre</option>
          <option value="year">Este ano</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Data início</span>
        <input type="date" [(ngModel)]="filters.dateFrom" (change)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Data fim</span>
        <input type="date" [(ngModel)]="filters.dateTo" (change)="applyFilters()">
      </div>
    </section>

    <div footer class="drawer-footer">
      <button class="btn-primary" (click)="sidebarVisible=false">Aplicar</button>
      <button class="btn-text" (click)="clearFilters()">Limpar</button>
    </div>
  </app-sidebar-filters>

  <app-custom-dialog [(visible)]="detailsVisible" title="Detalhes da Transação" [width]="'900px'">
    <div *ngIf="selectedTransaction" class="transaction-details">
      <div class="details-grid">
        <div class="detail-section">
          <h4>Informações Gerais</h4>
          <div class="detail-row">
            <span class="label">ID:</span>
            <span class="value">{{ selectedTransaction.id }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Parceiro:</span>
            <span class="value">{{ selectedTransaction.partnerName }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Marca:</span>
            <span class="value">{{ selectedTransaction.brandName }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Status:</span>
            <span class="tag" [ngClass]="getStatusClass(selectedTransaction.status)">
              {{ getStatusLabel(selectedTransaction.status) }}
            </span>
          </div>
          <div class="detail-row">
            <span class="label">Tipo:</span>
            <span class="value">{{ getTypeLabel(selectedTransaction.transactionType) }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Valores</h4>
          <div class="detail-row">
            <span class="label">Valor Bruto:</span>
            <span class="value">{{ fmt(selectedTransaction.amount, 'currency') }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Taxa:</span>
            <span class="value">{{ fmt(selectedTransaction.fee, 'currency') }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Valor Líquido:</span>
            <span class="value">{{ fmt(selectedTransaction.netAmount, 'currency') }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Comissão Parceiro:</span>
            <span class="value">{{ fmt(selectedTransaction.partnerCommission, 'currency') }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Taxa Plataforma:</span>
            <span class="value">{{ fmt(selectedTransaction.platformFee, 'currency') }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Cliente</h4>
          <div class="detail-row">
            <span class="label">Nome:</span>
            <span class="value">{{ selectedTransaction.customerName || 'N/A' }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Email:</span>
            <span class="value">{{ selectedTransaction.customerEmail }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.customerDocument">
            <span class="label">Documento:</span>
            <span class="value">{{ selectedTransaction.customerDocument }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Datas</h4>
          <div class="detail-row">
            <span class="label">Criação:</span>
            <span class="value">{{ selectedTransaction.createdAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.processedAt">
            <span class="label">Processamento:</span>
            <span class="value">{{ selectedTransaction.processedAt | date:'dd/MM/yyyy HH:mm:ss' }}</span>
          </div>
        </div>

        <div class="detail-section"
          *ngIf="selectedTransaction.transactionType === 'CREDIT_CARD' || selectedTransaction.transactionType === 'DEBIT_CARD'">
          <h4>Informações do Cartão</h4>
          <div class="detail-row" *ngIf="selectedTransaction.cardBrand">
            <span class="label">Bandeira:</span>
            <span class="value">{{ selectedTransaction.cardBrand }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.cardLastDigits">
            <span class="label">Final do Cartão:</span>
            <span class="value">****{{ selectedTransaction.cardLastDigits }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.installments">
            <span class="label">Parcelas:</span>
            <span class="value">{{ selectedTransaction.installments }}x</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.acquirer">
            <span class="label">Adquirente:</span>
            <span class="value">{{ selectedTransaction.acquirer }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.authorizationCode">
            <span class="label">Código Autorização:</span>
            <span class="value">{{ selectedTransaction.authorizationCode }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedTransaction.nsu">
            <span class="label">NSU:</span>
            <span class="value">{{ selectedTransaction.nsu }}</span>
          </div>
        </div>

        <div class="detail-section full-width">
          <h4>Descrição</h4>
          <div class="detail-row">
            <span class="value">{{ selectedTransaction.description }}</span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>
</section>
