<section class="container-wrapper">
  <header class="header">
    <h2>Credenciais de API</h2>
    <app-user-menu [username]="'Admin Sistema'" [email]="'admin@sistema.com'" [saldo]="0"
      [saldoProtesto]="0"></app-user-menu>
  </header>

  <!-- Action Bar -->
  <div class="action-bar">
    <button class="btn-primary" (click)="openCreateDialog()">
      <i class="pi pi-plus"></i>
      Nova Credencial
    </button>

    <div class="action-info">
      <span class="credential-count">{{ credentials.length }} credenciais</span>
    </div>
  </div>

  <!-- Copy Feedback -->
  <div class="copy-feedback" *ngIf="copyFeedback" [class.show]="copyFeedback">
    <i class="pi pi-check"></i>
    {{ copyFeedback }}
  </div>

  <!-- Credentials Grid -->
  <div class="credentials-grid" *ngIf="credentials.length > 0">
    <div class="credential-card" *ngFor="let credential of credentials" [attr.data-status]="credential.status">
      <div class="card-header">
        <div class="credential-info">
          <div class="credential-icon" [attr.data-env]="credential.environment">
            <i class="pi pi-key"></i>
          </div>
          <div class="credential-details">
            <h3 class="credential-name">{{ credential.name }}</h3>
            <p class="credential-description">{{ credential.description }}</p>
          </div>
        </div>

        <div class="credential-badges">
          <span class="status-badge" [ngClass]="getStatusClass(credential.status)">
            {{ credential.status | titlecase }}
          </span>
          <span class="env-badge" [ngClass]="getEnvironmentClass(credential.environment)">
            {{ credential.environment | titlecase }}
          </span>
        </div>
      </div>

      <div class="card-content">
        <div class="credential-keys">
          <div class="key-item">
            <label>API Key</label>
            <div class="key-value">
              <code>{{ maskKey(credential.apiKey) }}</code>
              <button class="copy-btn" (click)="copyToClipboard(credential.apiKey, 'API Key')" title="Copiar">
                <i class="pi pi-copy"></i>
              </button>
            </div>
          </div>

          <div class="key-item">
            <label>Secret Key</label>
            <div class="key-value">
              <code>{{ maskKey(credential.secretKey) }}</code>
              <button class="copy-btn" (click)="copyToClipboard(credential.secretKey, 'Secret Key')" title="Copiar">
                <i class="pi pi-copy"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="credential-stats">
          <div class="stat-item">
            <span class="stat-label">Uso</span>
            <span class="stat-value">{{ formatNumber(credential.usageCount) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Limite/h</span>
            <span class="stat-value">{{ formatNumber(credential.rateLimit) }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Último uso</span>
            <span class="stat-value">{{ formatDate(credential.lastUsed) }}</span>
          </div>
        </div>

        <div class="credential-permissions">
          <label>Permissões</label>
          <div class="permissions-list">
            <span class="permission-tag" *ngFor="let permission of credential.permissions">
              {{ permission.description }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-actions">
        <button class="action-btn view-btn" (click)="openViewDialog(credential)" title="Visualizar">
          <i class="pi pi-eye"></i>
        </button>

        <button class="action-btn edit-btn" (click)="openEditDialog(credential)" title="Editar">
          <i class="pi pi-pencil"></i>
        </button>

        <button class="action-btn toggle-btn" (click)="toggleCredentialStatus(credential)"
          [disabled]="credential.status === 'revoked'"
          [title]="credential.status === 'active' ? 'Desativar' : 'Ativar'">
          <i class="pi" [ngClass]="credential.status === 'active' ? 'pi-pause' : 'pi-play'"></i>
        </button>

        <button class="action-btn regenerate-btn" (click)="regenerateKeys(credential)"
          [disabled]="credential.status === 'revoked'" title="Regenerar Chaves">
          <i class="pi pi-refresh"></i>
        </button>

        <button class="action-btn revoke-btn" (click)="openRevokeDialog(credential)"
          [disabled]="credential.status === 'revoked'" title="Revogar">
          <i class="pi pi-ban"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="credentials.length === 0">
    <div class="empty-icon">
      <i class="pi pi-key"></i>
    </div>
    <h3>Nenhuma credencial encontrada</h3>
    <p>Crie sua primeira credencial de API para começar a integrar com nossos serviços.</p>
    <button class="btn-primary" (click)="openCreateDialog()">
      <i class="pi pi-plus"></i>
      Criar Primeira Credencial
    </button>
  </div>

  <!-- Create Credential Dialog -->
  <app-custom-dialog [(visible)]="createCredentialDialogVisible" title="Nova Credencial de API" [actions]="[
      {id:'create', label:'Criar Credencial', type:'primary'},
      {id:'cancel', label:'Cancelar', type:'text'}
    ]" (action)="handleCreateDialogAction($event)" width="700px">

    <div class="create-credential-form">
      <div class="form-section">
        <h4>Informações Básicas</h4>

        <div class="form-group">
          <label for="credentialName">Nome da Credencial *</label>
          <input type="text" id="credentialName" [(ngModel)]="createCredentialForm.name"
            placeholder="Ex: Produção Principal">
        </div>

        <div class="form-group">
          <label for="credentialDescription">Descrição</label>
          <textarea id="credentialDescription" [(ngModel)]="createCredentialForm.description"
            placeholder="Descreva o uso desta credencial" rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="environment">Ambiente</label>
            <select id="environment" [(ngModel)]="createCredentialForm.environment">
              <option value="sandbox">Sandbox</option>
              <option value="production">Produção</option>
            </select>
          </div>

          <div class="form-group">
            <label for="rateLimit">Limite por Hora</label>
            <input type="number" id="rateLimit" [(ngModel)]="createCredentialForm.rateLimit" min="100" max="10000">
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Permissões</h4>
        <div class="permissions-grid">
          <div class="permission-item" *ngFor="let permission of availablePermissions">
            <label class="permission-checkbox">
              <input type="checkbox" [checked]="hasPermission(permission.resource)"
                (change)="togglePermission(permission.resource)">
              <div class="permission-info">
                <span class="permission-name">{{ permission.description }}</span>
                <span class="permission-actions">{{ permission.actions.join(', ') }}</span>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Lista Branca de IPs</h4>
        <div class="ip-whitelist">
          <div class="ip-input">
            <input type="text" [(ngModel)]="newIpAddress" placeholder="192.168.1.100"
              pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
            <button type="button" class="btn-add-ip" (click)="addIpToWhitelist(createCredentialForm.ipWhitelist)"
              [disabled]="!newIpAddress">
              <i class="pi pi-plus"></i>
            </button>
          </div>

          <div class="ip-list" *ngIf="createCredentialForm.ipWhitelist.length > 0">
            <div class="ip-tag" *ngFor="let ip of createCredentialForm.ipWhitelist">
              <span>{{ ip }}</span>
              <button type="button" class="remove-ip"
                (click)="removeIpFromWhitelist(createCredentialForm.ipWhitelist, ip)">
                <i class="pi pi-times"></i>
              </button>
            </div>
          </div>

          <small class="form-help">Deixe vazio para permitir qualquer IP</small>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <!-- View Credential Dialog -->
  <app-custom-dialog [(visible)]="viewCredentialDialogVisible" title="Detalhes da Credencial" [actions]="[
      {id:'close', label:'Fechar', type:'text'}
    ]" (action)="handleViewDialogAction($event)" width="800px">

    <div class="view-credential-content" *ngIf="selectedCredential">
      <div class="credential-overview">
        <div class="overview-header">
          <div class="credential-icon" [attr.data-env]="selectedCredential.environment">
            <i class="pi pi-key"></i>
          </div>
          <div class="credential-info">
            <h3>{{ selectedCredential.name }}</h3>
            <p>{{ selectedCredential.description }}</p>
          </div>
          <div class="credential-status">
            <span class="status-badge" [ngClass]="getStatusClass(selectedCredential.status)">
              {{ selectedCredential.status | titlecase }}
            </span>
          </div>
        </div>

        <div class="overview-stats">
          <div class="stat-card">
            <span class="stat-label">Total de Uso</span>
            <span class="stat-value">{{ formatNumber(selectedCredential.usageCount) }}</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Limite por Hora</span>
            <span class="stat-value">{{ formatNumber(selectedCredential.rateLimit) }}</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Último Uso</span>
            <span class="stat-value">{{ formatDate(selectedCredential.lastUsed) }}</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Criada em</span>
            <span class="stat-value">{{ formatDate(selectedCredential.createdAt) }}</span>
          </div>
        </div>
      </div>

      <div class="credential-details">
        <div class="detail-section">
          <h4>Chaves de API</h4>
          <div class="key-display">
            <div class="key-item">
              <label>API Key</label>
              <div class="key-value">
                <code>{{ selectedCredential.apiKey }}</code>
                <button class="copy-btn" (click)="copyToClipboard(selectedCredential.apiKey, 'API Key')">
                  <i class="pi pi-copy"></i>
                </button>
              </div>
            </div>
            <div class="key-item">
              <label>Secret Key</label>
              <div class="key-value">
                <code>{{ selectedCredential.secretKey }}</code>
                <button class="copy-btn" (click)="copyToClipboard(selectedCredential.secretKey, 'Secret Key')">
                  <i class="pi pi-copy"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Permissões</h4>
          <div class="permissions-display">
            <div class="permission-item" *ngFor="let permission of selectedCredential.permissions">
              <div class="permission-header">
                <i class="pi pi-shield"></i>
                <span class="permission-name">{{ permission.description }}</span>
              </div>
              <div class="permission-actions">
                <span class="action-tag" *ngFor="let action of permission.actions">{{ action }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="detail-section" *ngIf="selectedCredential.ipWhitelist.length > 0">
          <h4>IPs Autorizados</h4>
          <div class="ip-display">
            <span class="ip-tag" *ngFor="let ip of selectedCredential.ipWhitelist">{{ ip }}</span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <!-- Edit Credential Dialog -->
  <app-custom-dialog [(visible)]="editCredentialDialogVisible" title="Editar Credencial" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'cancel', label:'Cancelar', type:'text'}
    ]" (action)="handleEditDialogAction($event)" width="600px">

    <div class="edit-credential-form" *ngIf="selectedCredential">
      <div class="form-group">
        <label for="editName">Nome da Credencial</label>
        <input type="text" id="editName" [(ngModel)]="editCredentialForm.name">
      </div>

      <div class="form-group">
        <label for="editDescription">Descrição</label>
        <textarea id="editDescription" [(ngModel)]="editCredentialForm.description" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label for="editRateLimit">Limite por Hora</label>
        <input type="number" id="editRateLimit" [(ngModel)]="editCredentialForm.rateLimit" min="100" max="10000">
      </div>

      <div class="form-group">
        <label>Lista Branca de IPs</label>
        <div class="ip-whitelist">
          <div class="ip-input">
            <input type="text" [(ngModel)]="newIpAddress" placeholder="192.168.1.100">
            <button type="button" class="btn-add-ip" (click)="addIpToWhitelist(editCredentialForm.ipWhitelist!)"
              [disabled]="!newIpAddress">
              <i class="pi pi-plus"></i>
            </button>
          </div>

          <div class="ip-list" *ngIf="editCredentialForm.ipWhitelist && editCredentialForm.ipWhitelist.length > 0">
            <div class="ip-tag" *ngFor="let ip of editCredentialForm.ipWhitelist">
              <span>{{ ip }}</span>
              <button type="button" class="remove-ip"
                (click)="removeIpFromWhitelist(editCredentialForm.ipWhitelist!, ip)">
                <i class="pi pi-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <!-- Revoke Credential Dialog -->
  <app-custom-dialog [(visible)]="revokeCredentialDialogVisible" title="Revogar Credencial" [actions]="[
      {id:'revoke', label:'Revogar', type:'primary'},
      {id:'cancel', label:'Cancelar', type:'text'}
    ]" (action)="handleRevokeDialogAction($event)" width="500px">

    <div class="revoke-credential-content" *ngIf="selectedCredential">
      <div class="warning-message">
        <i class="pi pi-exclamation-triangle"></i>
        <div class="warning-text">
          <h4>Atenção!</h4>
          <p>Você está prestes a revogar a credencial <strong>"{{ selectedCredential.name }}"</strong>.</p>
          <p>Esta ação é <strong>irreversível</strong> e todas as integrações que usam esta credencial irão parar de
            funcionar imediatamente.</p>
        </div>
      </div>

      <div class="credential-summary">
        <div class="summary-item">
          <span class="label">Nome:</span>
          <span class="value">{{ selectedCredential.name }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Ambiente:</span>
          <span class="value">{{ selectedCredential.environment | titlecase }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Último uso:</span>
          <span class="value">{{ formatDate(selectedCredential.lastUsed) }}</span>
        </div>
      </div>
    </div>
  </app-custom-dialog>
</section>