<section class="container-wrapper">
  <header class="header">
    <h2>Meus Clientes</h2>
    <app-user-menu [username]="'Admin Sistema'" [email]="'admin@sistema.com'" [saldo]="0" [saldoProtesto]="0">
    </app-user-menu>
  </header>

  <div class="metrics-grid">
    <app-summary-card class="width-max" title="Total de Clientes" [value]="fmt(metrics.totalClients, 'int')"
      icon="pi pi-users" delta="+{{metrics.newClientsThisMonth}} este mês" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Clientes Ativos" [value]="fmt(metrics.activeClients, 'int')"
      icon="pi pi-user-check" delta="+5.2%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Volume Total" [value]="fmt(metrics.totalVolume, 'currency', 0, 0)"
      icon="pi pi-chart-line" delta="+18.5%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Ticket Médio" [value]="fmt(metrics.averageTicket, 'currency', 0, 0)"
      icon="pi pi-receipt" delta="+5.2%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Taxa de Conversão" [value]="fmt(metrics.conversionRate, 'percent', 1, 1)"
      icon="pi pi-percentage" delta="+3.1%" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Novos Clientes" [value]="fmt(metrics.newClientsThisMonth, 'int')"
      icon="pi pi-user-plus" delta="+12.8%" deltaType="up">
    </app-summary-card>
  </div>

  <app-filter-tabs [tabs]="[
        { label: 'Todos',        value: '' },
        { label: 'Ativos',       value: 'ACTIVE' },
        { label: 'Inativos',     value: 'INACTIVE' },
        { label: 'Pendentes',    value: 'PENDING' },
        { label: 'Bloqueados',   value: 'BLOCKED' }
      ]" [selected]="filters.status" (selectedChange)="setStatus($event)" [search]="filters.search"
    (searchChange)="filters.search = $event; applyFilters()" searchPlaceholder="Buscar cliente, parceiro ou marca…"
    (export)="exportCSV()" (filterClick)="sidebarVisible = true">
  </app-filter-tabs>

  <div class="clients-container">
    <div class="clients-grid">
      <div class="client-card" *ngFor="let client of paginatedClients" (click)="viewDetails(client)">
        <div class="card-header">
          <div class="avatar-container">
            <img [src]="client.avatar" [alt]="client.clientName" class="client-avatar" />
            <div class="status-indicator" [ngClass]="getStatusClass(client.status)"></div>
          </div>
          <div class="client-info">
            <h3 class="client-name">{{ client.clientName }}</h3>
            <p class="client-email">{{ client.clientEmail }}</p>
            <span class="client-id">{{ client.id }}</span>
          </div>
        </div>

        <div class="card-content">
          <div class="partner-section">
            <div class="partner-item">
              <span class="label">Parceiro</span>
              <span class="value">{{ client.partnerName }}</span>
            </div>
            <div class="partner-item">
              <span class="label">Marca</span>
              <span class="value">{{ client.brandName }}</span>
            </div>
          </div>

          <div class="metrics-section">
            <div class="metric">
              <span class="metric-value">{{ client.totalTransactions }}</span>
              <span class="metric-label">Transações</span>
            </div>
            <div class="metric">
              <span class="metric-value">{{ fmt(client.totalVolume, 'currency', 0, 0) }}</span>
              <span class="metric-label">Volume</span>
            </div>
          </div>

          <div class="badges-section">
            <span class="badge type-badge">{{ getTypeLabel(client.clientType) }}</span>
            <span class="badge kyc-badge" [ngClass]="getKycClass(client.kycStatus)">
              {{ getKycLabel(client.kycStatus) }}
            </span>
            <span class="badge risk-badge" [ngClass]="getRiskClass(client.riskLevel)">
              {{ getRiskLabel(client.riskLevel) }}
            </span>
          </div>
        </div>

        <div class="card-footer">
          <span class="registration-date">
            Cadastrado em {{ client.registrationDate | date:'dd/MM/yyyy' }}
          </span>
          <span class="last-activity">
            {{ getActivityStatus(client.lastActivity) }}
          </span>
        </div>
      </div>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
        <i class="pi pi-chevron-left"></i>
      </button>

      <span class="page-info">
        {{ currentPage }} de {{ totalPages }} • {{ filteredClients.length }} clientes
      </span>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
        <i class="pi pi-chevron-right"></i>
      </button>
    </div>
  </div>

  <app-sidebar-filters [(visible)]="sidebarVisible" width="360px">
    <h3 header>Filtros de Clientes</h3>

    <section class="drawer-content no-scrollbar">
      <div class="field">
        <span class="caption">Buscar</span>
        <input type="text" [(ngModel)]="filters.search" (input)="applyFilters()" placeholder="Nome, email, parceiro...">
      </div>

      <div class="field">
        <span class="caption">Status</span>
        <select [(ngModel)]="filters.status" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="ACTIVE">Ativo</option>
          <option value="INACTIVE">Inativo</option>
          <option value="PENDING">Pendente</option>
          <option value="BLOCKED">Bloqueado</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Tipo de Cliente</span>
        <select [(ngModel)]="filters.clientType" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="INDIVIDUAL">Pessoa Física</option>
          <option value="BUSINESS">Pessoa Jurídica</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Status KYC</span>
        <select [(ngModel)]="filters.kycStatus" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="APPROVED">Aprovado</option>
          <option value="PENDING">Pendente</option>
          <option value="REJECTED">Rejeitado</option>
          <option value="EXPIRED">Expirado</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Nível de Risco</span>
        <select [(ngModel)]="filters.riskLevel" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="LOW">Baixo</option>
          <option value="MEDIUM">Médio</option>
          <option value="HIGH">Alto</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Parceiro</span>
        <input type="text" [(ngModel)]="filters.partnerName" (input)="applyFilters()" placeholder="Nome do parceiro">
      </div>

      <div class="field">
        <span class="caption">Marca</span>
        <input type="text" [(ngModel)]="filters.brandName" (input)="applyFilters()" placeholder="Nome da marca">
      </div>

      <div class="field">
        <span class="caption">Volume mínimo</span>
        <input type="number" [(ngModel)]="filters.minVolume" (input)="applyFilters()" placeholder="0,00">
      </div>

      <div class="field">
        <span class="caption">Volume máximo</span>
        <input type="number" [(ngModel)]="filters.maxVolume" (input)="applyFilters()" placeholder="0,00">
      </div>
    </section>

    <div footer class="drawer-footer">
      <button class="btn-primary" (click)="sidebarVisible=false">Aplicar</button>
      <button class="btn-text" (click)="clearFilters()">Limpar</button>
    </div>
  </app-sidebar-filters>

  <div class="modal-overlay" *ngIf="detailsVisible" (click)="detailsVisible = false">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="header-content">
          <img [src]="selectedClient.avatar" [alt]="selectedClient.clientName" class="modal-avatar" />
          <div class="header-info">
            <h2>{{ selectedClient.clientName }}</h2>
            <p>{{ selectedClient.clientEmail }}</p>
            <span class="modal-client-id">{{ selectedClient.id }}</span>
          </div>
        </div>
        <button class="close-button" (click)="detailsVisible = false">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="info-section">
          <h3>Status</h3>
          <div class="status-grid">
            <div class="status-item">
              <span class="badge" [ngClass]="getStatusClass(selectedClient.status || '')">
                {{ getStatusLabel(selectedClient.status || '') }}
              </span>
            </div>
            <div class="status-item">
              <span class="badge" [ngClass]="getKycClass(selectedClient.kycStatus || '')">
                KYC: {{ getKycLabel(selectedClient.kycStatus || '') }}
              </span>
            </div>
            <div class="status-item">
              <span class="badge" [ngClass]="getRiskClass(selectedClient.riskLevel || '')">
                Risco: {{ getRiskLabel(selectedClient.riskLevel || '') }}
              </span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>Performance</h3>
          <div class="metrics-grid-modal">
            <div class="metric-card">
              <div class="metric-icon">
                <i class="pi pi-shopping-cart"></i>
              </div>
              <div class="metric-content">
                <span class="metric-number">{{ selectedClient.totalTransactions | number }}</span>
                <span class="metric-text">Transações</span>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-icon">
                <i class="pi pi-chart-line"></i>
              </div>
              <div class="metric-content">
                <span class="metric-number">{{ fmt(selectedClient.totalVolume || 0, 'currency', 0, 0) }}</span>
                <span class="metric-text">Volume Total</span>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-icon">
                <i class="pi pi-receipt"></i>
              </div>
              <div class="metric-content">
                <span class="metric-number">{{ fmt(selectedClient.averageTicket || 0, 'currency', 0, 0) }}</span>
                <span class="metric-text">Ticket Médio</span>
              </div>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>Informações de Contato</h3>
          <div class="contact-grid">
            <div class="contact-item">
              <i class="pi pi-phone"></i>
              <span>{{ selectedClient.clientPhone }}</span>
            </div>
            <div class="contact-item">
              <i class="pi pi-id-card"></i>
              <span>{{ formatDocument(selectedClient.clientDocument || '', selectedClient.clientType || '') }}</span>
            </div>
            <div class="contact-item">
              <i class="pi pi-map-marker"></i>
              <span>{{ selectedClient.address.city }}, {{ selectedClient.address.state }}</span>
            </div>
            <div class="contact-item">
              <i class="pi pi-credit-card"></i>
              <span>{{ selectedClient.preferredPaymentMethod }}</span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>Parceria</h3>
          <div class="partner-grid">
            <div class="partner-detail">
              <span class="detail-label">Parceiro</span>
              <span class="detail-value">{{ selectedClient.partnerName }}</span>
            </div>
            <div class="partner-detail">
              <span class="detail-label">Marca</span>
              <span class="detail-value">{{ selectedClient.brandName }}</span>
            </div>
            <div class="partner-detail">
              <span class="detail-label">Tipo</span>
              <span class="detail-value">{{ getTypeLabel(selectedClient.clientType || '') }}</span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3>Datas</h3>
          <div class="dates-grid">
            <div class="date-item">
              <span class="date-label">Cadastro</span>
              <span class="date-value">{{ selectedClient.registrationDate | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="date-item">
              <span class="date-label">Última Atividade</span>
              <span class="date-value">{{ getActivityStatus(selectedClient.lastActivity) }}</span>
            </div>
          </div>
        </div>

        <div class="info-section" *ngIf="selectedClient.tags && selectedClient.tags.length > 0">
          <h3>Tags</h3>
          <div class="tags-container">
            <span class="tag-item" *ngFor="let tag of selectedClient.tags">{{ tag }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>