<section class="container-wrapper">
  <header class="header">
    <h2>Todos os Saques</h2>
    <app-user-menu [username]="'Admin Sistema'" [email]="'admin@sistema.com'" [saldo]="0" [saldoProtesto]="0">
    </app-user-menu>
  </header>



  <div class="metrics-grid">
    <app-summary-card class="width-max" title="Total de Saques" [value]="fmt(metrics.totalWithdrawals, 'int')"
      icon="pi pi-money-bill" [delta]="'+12%'" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Volume Total" [value]="fmt(metrics.totalAmount, 'currency')"
      icon="pi pi-chart-line" [delta]="'+8.5%'" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Total em Taxas" [value]="fmt(metrics.totalFees, 'currency')"
      icon="pi pi-percentage" [delta]="'+15%'" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Ticket Médio" [value]="fmt(metrics.averageAmount, 'currency')"
      icon="pi pi-calculator" [delta]="'+3.2%'" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Taxa de Sucesso" [value]="fmt(metrics.conversionRate, 'percent', 1, 1)"
      icon="pi pi-check-circle" [delta]="'+2.1%'" deltaType="up">
    </app-summary-card>

    <app-summary-card class="width-max" title="Tempo Médio" [value]="metrics.averageProcessingTime + 'h'"
      icon="pi pi-clock" [delta]="'-15min'" deltaType="up">
    </app-summary-card>
  </div>
  <app-filter-tabs [tabs]="[
        { label: 'Todos', value: '' },
        { label: 'Pendentes', value: 'pending' },
        { label: 'Processando', value: 'processing' },
        { label: 'Concluídos', value: 'completed' },
        { label: 'Falharam', value: 'failed' },
        { label: 'Cancelados', value: 'cancelled' }
      ]" [selected]="filters.status" (selectedChange)="setStatus($event)" [search]="filters.search"
    (searchChange)="filters.search = $event; applyFilters()" searchPlaceholder="Buscar usuário, email ou ID…"
    (export)="exportCSV()" (filterClick)="sidebarVisible = true">
  </app-filter-tabs>
  <div class="table-card">
    <div class="table-scroll">
      <table class="user-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Usuário</th>
            <th>Valor</th>
            <th>Taxa</th>
            <th>Líquido</th>
            <th>Método</th>
            <th>Status</th>
            <th>Prioridade</th>
            <th>Data</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let withdrawal of paginatedWithdrawals">
            <td>
              <span class="id-badge">{{ withdrawal.id }}</span>
            </td>
            <td>
              <div class="user-info">
                <div>
                  <div class="name">{{ withdrawal.userName }}</div>
                  <div class="handle">{{ withdrawal.userEmail }}</div>
                </div>
              </div>
            </td>
            <td>
              <span class="amount">{{ fmt(withdrawal.amount, 'currency') }}</span>
            </td>
            <td>
              <span class="fee">{{ fmt(withdrawal.fee, 'currency') }}</span>
            </td>
            <td>
              <span class="net-amount">{{ fmt(withdrawal.netAmount, 'currency') }}</span>
            </td>
            <td>
              <span class="method">{{ getMethodLabel(withdrawal.method) }}</span>
            </td>
            <td>
              <span class="tag" [ngClass]="getStatusClass(withdrawal.status)">
                {{ withdrawal.status }}
              </span>
            </td>
            <td>
              <span class="tag" [ngClass]="getPriorityClass(withdrawal.priority)">
                {{ withdrawal.priority }}
              </span>
            </td>
            <td>
              <span class="date">{{ withdrawal.requestDate | date:'dd/MM/yyyy' }}</span>
            </td>
            <td>
              <button class="btn-action" (click)="viewDetails(withdrawal)">
                <i class="pi pi-eye"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
        <i class="pi pi-chevron-left"></i>
      </button>

      <span class="page-info">
        Página {{ currentPage }} de {{ totalPages }}
      </span>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
        <i class="pi pi-chevron-right"></i>
      </button>
    </div>
  </div>

  <app-sidebar-filters [(visible)]="sidebarVisible" width="360px">
    <h3 header>Filtros de Saques</h3>

    <section class="drawer-content no-scrollbar">
      <div class="field">
        <span class="caption">Usuário/Email/ID</span>
        <input type="text" [(ngModel)]="filters.search" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Status</span>
        <select [(ngModel)]="filters.status" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="pending">Pendente</option>
          <option value="processing">Processando</option>
          <option value="completed">Concluído</option>
          <option value="failed">Falhou</option>
          <option value="cancelled">Cancelado</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Método</span>
        <select [(ngModel)]="filters.method" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="pix">PIX</option>
          <option value="ted">TED</option>
          <option value="bank_transfer">Transferência</option>
          <option value="crypto">Crypto</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Prioridade</span>
        <select [(ngModel)]="filters.priority" (change)="applyFilters()">
          <option value="">Todas</option>
          <option value="low">Baixa</option>
          <option value="normal">Normal</option>
          <option value="high">Alta</option>
          <option value="urgent">Urgente</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Valor mínimo</span>
        <input type="number" [(ngModel)]="filters.minAmount" (input)="applyFilters()" placeholder="R$ 0,00">
      </div>

      <div class="field">
        <span class="caption">Valor máximo</span>
        <input type="number" [(ngModel)]="filters.maxAmount" (input)="applyFilters()" placeholder="R$ 10.000,00">
      </div>

      <div class="field">
        <span class="caption">Aprovado por</span>
        <input type="text" [(ngModel)]="filters.approvedBy" (input)="applyFilters()" placeholder="Nome do aprovador">
      </div>

      <div class="field">
        <span class="caption">Período</span>
        <select [(ngModel)]="filters.period" (change)="applyFilters()">
          <option value="all">Todos</option>
          <option value="today">Hoje</option>
          <option value="week">Últimos 7 dias</option>
          <option value="month">Este mês</option>
          <option value="quarter">Este trimestre</option>
          <option value="year">Este ano</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Data início</span>
        <input type="date" [(ngModel)]="filters.dateFrom" (change)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Data fim</span>
        <input type="date" [(ngModel)]="filters.dateTo" (change)="applyFilters()">
      </div>
    </section>

    <div footer class="drawer-footer">
      <button class="btn-primary" (click)="sidebarVisible=false; updateMetrics()">Aplicar</button>
      <button class="btn-text" (click)="clearFilters()">Limpar</button>
    </div>
  </app-sidebar-filters>

  <app-custom-dialog [(visible)]="dialogVisible" title="Detalhes do Saque" [width]="'600px'">

    <div *ngIf="selectedWithdrawal" class="dialog-content">
      <div class="detail-section">
        <h4>Informações Gerais</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>ID do Saque:</label>
            <span>{{ selectedWithdrawal.id }}</span>
          </div>
          <div class="detail-item">
            <label>Status:</label>
            <span class="tag" [ngClass]="getStatusClass(selectedWithdrawal.status)">
              {{ selectedWithdrawal.status }}
            </span>
          </div>
          <div class="detail-item">
            <label>Prioridade:</label>
            <span class="tag" [ngClass]="getPriorityClass(selectedWithdrawal.priority)">
              {{ selectedWithdrawal.priority }}
            </span>
          </div>
          <div class="detail-item">
            <label>Método:</label>
            <span>{{ getMethodLabel(selectedWithdrawal.method) }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4>Informações do Usuário</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Nome:</label>
            <span>{{ selectedWithdrawal.userName }}</span>
          </div>
          <div class="detail-item">
            <label>Email:</label>
            <span>{{ selectedWithdrawal.userEmail }}</span>
          </div>
          <div class="detail-item">
            <label>ID do Usuário:</label>
            <span>{{ selectedWithdrawal.userId }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4>Valores</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Valor Solicitado:</label>
            <span class="amount">{{ fmt(selectedWithdrawal.amount, 'currency') }}</span>
          </div>
          <div class="detail-item">
            <label>Taxa:</label>
            <span class="fee">{{ fmt(selectedWithdrawal.fee, 'currency') }}</span>
          </div>
          <div class="detail-item">
            <label>Valor Líquido:</label>
            <span class="net-amount">{{ fmt(selectedWithdrawal.netAmount, 'currency') }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedWithdrawal.bankAccount">
        <h4>Dados Bancários</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Banco:</label>
            <span>{{ selectedWithdrawal.bankAccount.bank }}</span>
          </div>
          <div class="detail-item">
            <label>Agência:</label>
            <span>{{ selectedWithdrawal.bankAccount.agency }}</span>
          </div>
          <div class="detail-item">
            <label>Conta:</label>
            <span>{{ selectedWithdrawal.bankAccount.account }}</span>
          </div>
          <div class="detail-item">
            <label>Tipo:</label>
            <span>{{ selectedWithdrawal.bankAccount.accountType === 'checking' ? 'Corrente' : 'Poupança' }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section" *ngIf="selectedWithdrawal.pixKey">
        <h4>Chave PIX</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Chave:</label>
            <span>{{ selectedWithdrawal.pixKey }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4>Datas</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Solicitação:</label>
            <span>{{ selectedWithdrawal.requestDate | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedWithdrawal.processedDate">
            <label>Processamento:</label>
            <span>{{ selectedWithdrawal.processedDate | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedWithdrawal.completedDate">
            <label>Conclusão:</label>
            <span>{{ selectedWithdrawal.completedDate | date:'dd/MM/yyyy HH:mm' }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section"
        *ngIf="selectedWithdrawal.approvedBy || selectedWithdrawal.transactionId || selectedWithdrawal.reason || selectedWithdrawal.notes">
        <h4>Informações Adicionais</h4>
        <div class="detail-grid">
          <div class="detail-item" *ngIf="selectedWithdrawal.approvedBy">
            <label>Aprovado por:</label>
            <span>{{ selectedWithdrawal.approvedBy }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedWithdrawal.transactionId">
            <label>ID da Transação:</label>
            <span>{{ selectedWithdrawal.transactionId }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedWithdrawal.reason">
            <label>Motivo:</label>
            <span>{{ selectedWithdrawal.reason }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedWithdrawal.notes">
            <label>Observações:</label>
            <span>{{ selectedWithdrawal.notes }}</span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>
</section>