<section class="container-wrapper">
  <header class="header">
    <h2>Todas as Empresas</h2>
    <app-user-menu [username]="'Admin Sistema'" [email]="'admin@sistema.com'" [saldo]="0" [saldoProtesto]="0">
    </app-user-menu>
  </header>



  <div class="summary-grid">
    <app-summary-card class="width-max" title="Total de Empresas" [value]="fmt(metrics.totalCompanies, 'int')"
      icon="pi pi-building">
    </app-summary-card>

    <app-summary-card class="width-max" title="Empresas Ativas" [value]="fmt(metrics.activeCompanies, 'int')"
      icon="pi pi-check-circle">
    </app-summary-card>

    <app-summary-card class="width-max" title="KYC Pendente" [value]="fmt(metrics.pendingKyc, 'int')"
      icon="pi pi-clock">
    </app-summary-card>

    <app-summary-card class="width-max" title="Receita Total" [value]="fmt(metrics.totalRevenue, 'currency')"
      icon="pi pi-dollar">
    </app-summary-card>

    <app-summary-card class="width-max" title="Receita Média" [value]="fmt(metrics.averageRevenue, 'currency')"
      icon="pi pi-chart-line">
    </app-summary-card>

    <app-summary-card class="width-max" title="Taxa de Conversão" [value]="fmt(metrics.conversionRate, 'percent', 1, 1)"
      icon="pi pi-percentage">
    </app-summary-card>
  </div>
  <app-filter-tabs [tabs]="[
        { label: 'Todas', value: '' },
        { label: 'Ativas', value: 'active' },
        { label: 'Pendentes', value: 'pending' },
        { label: 'Inativas', value: 'inactive' },
        { label: 'Bloqueadas', value: 'blocked' }
      ]" [selected]="filters.status" (selectedChange)="setStatus($event)" [search]="filters.search"
    (searchChange)="filters.search = $event; applyFilters()" searchPlaceholder="Buscar empresa ou CNPJ…"
    (export)="exportCSV()" (filterClick)="sidebarVisible = true">
  </app-filter-tabs>
  <div class="table-card">
    <div class="table-header">
      <h3>Lista de Empresas ({{ totalItems }})</h3>
    </div>

    <div class="table-scroll">
      <table class="user-table">
        <thead>
          <tr>
            <th>Empresa</th>
            <th>CNPJ</th>
            <th>Categoria</th>
            <th>Status</th>
            <th>KYC</th>
            <th>Receita</th>
            <th>Funcionários</th>
            <th>Estado</th>
            <th>Criado em</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let company of paginatedCompanies">
            <td>
              <div class="user-info">
                <div>
                  <div class="name">{{ company.name }}</div>
                  <div class="handle">{{ company.email }}</div>
                </div>
              </div>
            </td>
            <td>{{ company.cnpj }}</td>
            <td>{{ company.category }}</td>
            <td>
              <span class="tag" [ngClass]="getStatusClass(company.status)">
                {{ company.status | titlecase }}
              </span>
            </td>
            <td>
              <span class="tag" [ngClass]="getKycStatusClass(company.kycStatus)">
                {{ company.kycStatus | titlecase }}
              </span>
            </td>
            <td>{{ fmt(company.totalRevenue, 'currency') }}</td>
            <td>{{ company.employees }}</td>
            <td>{{ company.address.state }}</td>
            <td>{{ company.createdAt | date:'dd/MM/yyyy' }}</td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit-btn" (click)="editCompany(company)">
                  <i class="pi pi-pencil"></i>
                </button>
                <button class="action-btn view-btn" (click)="viewCompany(company)">
                  <i class="pi pi-eye"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>


  </div>
   <orb-pagination [currentPage]="currentPage" [totalPages]="totalItems" (pageChange)="onPageChange($event)">
    </orb-pagination>

  <app-sidebar-filters [(visible)]="sidebarVisible" width="360px">
    <h3 header>Filtros de Empresas</h3>

    <div class="drawer-content no-scrollbar">
      <div class="field">
        <span class="caption">Nome/Email/CNPJ</span>
        <input type="text" [(ngModel)]="filters.search" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Status da Empresa</span>
        <select [(ngModel)]="filters.status" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="active">Ativa</option>
          <option value="inactive">Inativa</option>
          <option value="pending">Pendente</option>
          <option value="blocked">Bloqueada</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Status KYC</span>
        <select [(ngModel)]="filters.kycStatus" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="approved">Aprovado</option>
          <option value="pending">Pendente</option>
          <option value="rejected">Rejeitado</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Categoria</span>
        <select [(ngModel)]="filters.category" (change)="applyFilters()">
          <option value="">Todas</option>
          <option value="Tecnologia">Tecnologia</option>
          <option value="Marketing">Marketing</option>
          <option value="Varejo">Varejo</option>
          <option value="Serviços">Serviços</option>
          <option value="Indústria">Indústria</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Estado</span>
        <select [(ngModel)]="filters.state" (change)="applyFilters()">
          <option value="">Todos</option>
          <option value="SP">São Paulo</option>
          <option value="RJ">Rio de Janeiro</option>
          <option value="MG">Minas Gerais</option>
          <option value="RS">Rio Grande do Sul</option>
          <option value="PR">Paraná</option>
        </select>
      </div>

      <div class="field">
        <span class="caption">Receita mínima</span>
        <input type="number" [(ngModel)]="filters.minRevenue" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Receita máxima</span>
        <input type="number" [(ngModel)]="filters.maxRevenue" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Funcionários mín.</span>
        <input type="number" [(ngModel)]="filters.minEmployees" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Funcionários máx.</span>
        <input type="number" [(ngModel)]="filters.maxEmployees" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Volume mensal mín.</span>
        <input type="number" [(ngModel)]="filters.minVolume" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Volume mensal máx.</span>
        <input type="number" [(ngModel)]="filters.maxVolume" (input)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Data de cadastro (início)</span>
        <input type="date" [(ngModel)]="filters.dateFrom" (change)="applyFilters()">
      </div>

      <div class="field">
        <span class="caption">Data de cadastro (fim)</span>
        <input type="date" [(ngModel)]="filters.dateTo" (change)="applyFilters()">
      </div>
    </div>

    <div footer class="drawer-footer">
      <button class="btn-primary" (click)="sidebarVisible=false; updateMetrics()">Aplicar</button>
      <button class="btn-text" (click)="clearFilters()">Limpar</button>
    </div>
  </app-sidebar-filters>

  <app-custom-dialog [(visible)]="companyDialogVisible" title="Detalhes da Empresa" [actions]="[
      {id:'close', label:'Fechar', type:'text'}
    ]" (action)="handleDialogAction($event)" width="900px" maxHeight="90vh">

    <div *ngIf="selectedCompany" class="company-details">
      <div class="details-grid">
        <div class="detail-section">
          <h4>Informações Básicas</h4>
          <div class="detail-item">
            <label>Nome:</label>
            <span>{{ selectedCompany.name }}</span>
          </div>
          <div class="detail-item">
            <label>CNPJ:</label>
            <span>{{ selectedCompany.cnpj }}</span>
          </div>
          <div class="detail-item">
            <label>Email:</label>
            <span>{{ selectedCompany.email }}</span>
          </div>
          <div class="detail-item">
            <label>Telefone:</label>
            <span>{{ selectedCompany.phone }}</span>
          </div>
          <div class="detail-item">
            <label>Categoria:</label>
            <span>{{ selectedCompany.category }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Endereço</h4>
          <div class="detail-item">
            <label>Rua:</label>
            <span>{{ selectedCompany.address.street }}, {{ selectedCompany.address.number }}</span>
          </div>
          <div class="detail-item">
            <label>Cidade:</label>
            <span>{{ selectedCompany.address.city }} - {{ selectedCompany.address.state }}</span>
          </div>
          <div class="detail-item">
            <label>CEP:</label>
            <span>{{ selectedCompany.address.zipCode }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Representante</h4>
          <div class="detail-item">
            <label>Nome:</label>
            <span>{{ selectedCompany.representative.name }}</span>
          </div>
          <div class="detail-item">
            <label>Email:</label>
            <span>{{ selectedCompany.representative.email }}</span>
          </div>
          <div class="detail-item">
            <label>CPF:</label>
            <span>{{ selectedCompany.representative.cpf }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Métricas</h4>
          <div class="detail-item">
            <label>Receita Total:</label>
            <span>{{ fmt(selectedCompany.totalRevenue, 'currency') }}</span>
          </div>
          <div class="detail-item">
            <label>Transações:</label>
            <span>{{ selectedCompany.totalTransactions }}</span>
          </div>
          <div class="detail-item">
            <label>Funcionários:</label>
            <span>{{ selectedCompany.employees }}</span>
          </div>
          <div class="detail-item">
            <label>Volume Mensal:</label>
            <span>{{ fmt(selectedCompany.monthlyVolume, 'currency') }}</span>
          </div>
          <div class="detail-item">
            <label>Status:</label>
            <span class="tag" [ngClass]="getStatusClass(selectedCompany.status)">
              {{ selectedCompany.status | titlecase }}
            </span>
          </div>
          <div class="detail-item">
            <label>Status KYC:</label>
            <span class="tag" [ngClass]="getKycStatusClass(selectedCompany.kycStatus)">
              {{ selectedCompany.kycStatus | titlecase }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="editCompanyDialogVisible" title="Detalhes da Empresa" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'close', label:'Fechar', type:'text'}
    ]" (action)="handleEditDialogAction($event)" width="600px" maxHeight="90vh">

    <div *ngIf="selectedCompany" class="edit-company-content">
      <div class="company-header">
        <div class="company-avatar">
          <span>{{ selectedCompany.name.charAt(0) }}</span>
        </div>
        <div class="company-info">
          <h3>{{ selectedCompany.name }}</h3>
          <p>{{ selectedCompany.cnpj }}</p>
        </div>
      </div>

      <div class="edit-options">
        <div class="edit-option" (click)="handleEditOption('fees')">
          <div class="option-icon">
            <i class="pi pi-percentage"></i>
          </div>
          <div class="option-content">
            <span class="option-title">Alterar Taxas</span>
          </div>
          <button class="option-btn">Editar</button>
        </div>

        <div class="edit-option" (click)="handleEditOption('permissions')">
          <div class="option-icon">
            <i class="pi pi-shield"></i>
          </div>
          <div class="option-content">
            <span class="option-title">Alterar permissões</span>
          </div>
          <button class="option-btn">Editar</button>
        </div>

        <div class="edit-option" (click)="handleEditOption('reserves')">
          <div class="option-icon">
            <i class="pi pi-wallet"></i>
          </div>
          <div class="option-content">
            <span class="option-title">Reservas financeiras</span>
          </div>
          <button class="option-btn">Editar</button>
        </div>

        <div class="edit-option" (click)="handleEditOption('acquirer')">
          <div class="option-icon">
            <i class="pi pi-building"></i>
          </div>
          <div class="option-content">
            <span class="option-title">Alterar Adquirente</span>
          </div>
          <button class="option-btn">Editar</button>
        </div>

        <div class="edit-option" (click)="handleEditOption('baas')">
          <div class="option-icon">
            <i class="pi pi-server"></i>
          </div>
          <div class="option-content">
            <span class="option-title">Alterar Baas</span>
          </div>
          <button class="option-btn">Editar</button>
        </div>

        <div class="edit-option" (click)="handleEditOption('subaccount')">
          <div class="option-icon">
            <i class="pi pi-eye"></i>
          </div>
          <div class="option-content">
            <span class="option-title">Visualizar Subconta</span>
          </div>
          <button class="option-btn secondary">Visualizar</button>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="feesDialogVisible" title="Alterar Taxas" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'close', label:'Fechar', type:'text'}
    ]" (action)="handleFeesDialogAction($event)" width="800px" maxHeight="90vh">

    <div class="fees-content">
      <div class="fees-section">
        <h4>Meios de Pagamentos</h4>
        <div class="payment-methods">
          <div class="payment-method">
            <i class="pi pi-credit-card"></i>
            <span>Cartão de crédito</span>
            <input type="checkbox" [(ngModel)]="companyPermissions.paymentMethods.creditCard">
          </div>

          <div class="payment-method">
            <i class="pi pi-mobile"></i>
            <span>PIX</span>
            <input type="checkbox" [(ngModel)]="companyPermissions.paymentMethods.pix">
          </div>

          <div class="payment-method">
            <i class="pi pi-file"></i>
            <span>Boleto</span>
            <input type="checkbox" [(ngModel)]="companyPermissions.paymentMethods.boleto">
          </div>
        </div>
      </div>

      <div class="fees-section">
        <h4>Taxas do cartão</h4>
        <div class="card-fees">
          <div class="fee-row">
            <span>Cartão taxa fixa</span>
            <span class="fee-value">{{ fmt(companyFees.cardFees.fixedFee, 'currency') }}</span>
          </div>

          <div class="installments-grid">
            <div *ngFor="let installment of cardFeesEntries" class="installment-row">
              <span>Cartão {{ installment.key }}</span>
              <span class="fee-value">{{ installment.value }}%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="fees-section">
        <h4>Taxas para PIX</h4>
        <div class="pix-fees">
          <div class="fee-row">
            <span>PIX taxa fixa</span>
            <span class="fee-value">{{ fmt(companyFees.pixFees.fixedFee, 'currency') }}</span>
          </div>
          <div class="fee-row">
            <span>PIX taxa variável</span>
            <span class="fee-value">{{ companyFees.pixFees.variableFee }}%</span>
          </div>
        </div>
      </div>

      <div class="fees-section">
        <h4>Taxas para boletos</h4>
        <div class="boleto-fees">
          <div class="fee-row">
            <span>Boleto taxa fixa</span>
            <span class="fee-value">{{ fmt(companyFees.boletoFees.fixedFee, 'currency') }}</span>
          </div>
          <div class="fee-row">
            <span>Boleto taxa variável</span>
            <span class="fee-value">{{ companyFees.boletoFees.variableFee }}%</span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="permissionsDialogVisible" title="Alterar Permissões" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'close', label:'Cancelar', type:'text'}
    ]" (action)="handlePermissionsDialogAction($event)" width="700px">

    <div class="permissions-content">
      <div class="permissions-section">
        <h4>Métodos de Pagamento</h4>
        <div class="permissions-grid">
          <div class="permission-item">
            <div class="permission-info">
              <i class="pi pi-credit-card"></i>
              <span>Cartão de Crédito</span>
            </div>
            <input type="checkbox" [(ngModel)]="companyPermissions.paymentMethods.creditCard">
          </div>

          <div class="permission-item">
            <div class="permission-info">
              <i class="pi pi-mobile"></i>
              <span>PIX</span>
            </div>
            <input type="checkbox" [(ngModel)]="companyPermissions.paymentMethods.pix">
          </div>

          <div class="permission-item">
            <div class="permission-info">
              <i class="pi pi-file"></i>
              <span>Boleto</span>
            </div>
            <input type="checkbox" [(ngModel)]="companyPermissions.paymentMethods.boleto">
          </div>
        </div>
      </div>

      <div class="permissions-section">
        <h4>Funcionalidades</h4>
        <div class="permissions-grid">
          <div class="permission-item">
            <div class="permission-info">
              <i class="pi pi-send"></i>
              <span>Transferências</span>
            </div>
            <input type="checkbox" [(ngModel)]="companyPermissions.features.transfers">
          </div>

          <div class="permission-item">
            <div class="permission-info">
              <i class="pi pi-wallet"></i>
              <span>Saques</span>
            </div>
            <input type="checkbox" [(ngModel)]="companyPermissions.features.withdrawals">
          </div>
        </div>
      </div>

      <div class="permissions-section">
        <h4>Limites</h4>
        <div class="limits-grid">
          <div class="limit-item">
            <label>Limite Diário</label>
            <input type="number" [(ngModel)]="companyPermissions.limits.dailyLimit">
          </div>

          <div class="limit-item">
            <label>Limite Mensal</label>
            <input type="number" [(ngModel)]="companyPermissions.limits.monthlyLimit">
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="financialReservesDialogVisible" title="Reservas Financeiras" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'close', label:'Cancelar', type:'text'}
    ]" (action)="handleFinancialReservesDialogAction($event)" width="800px">

    <div class="reserves-content">
      <div class="reserves-summary">
        <div class="summary-card">
          <h4>Reserva Atual</h4>
          <span class="amount">{{ fmt(financialReserves.currentReserve, 'currency') }}</span>
        </div>

        <div class="summary-card">
          <h4>Reserva Mínima</h4>
          <span class="amount">{{ fmt(financialReserves.minimumReserve, 'currency') }}</span>
        </div>

        <div class="summary-card">
          <h4>Percentual</h4>
          <span class="amount">{{ financialReserves.reservePercentage }}%</span>
        </div>
      </div>

      <div class="reserves-config">
        <h4>Configurações</h4>
        <div class="config-item">
          <span>Reserva Automática</span>
          <input type="checkbox" [(ngModel)]="financialReserves.autoReserve">
        </div>

        <div class="config-item">
          <label>Percentual de Reserva</label>
          <input type="number" [(ngModel)]="financialReserves.reservePercentage" min="0" max="100">
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="acquirerDialogVisible" title="Alterar Adquirente" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'close', label:'Cancelar', type:'text'}
    ]" (action)="handleAcquirerDialogAction($event)" width="700px">

    <div class="acquirer-content">
      <div class="current-acquirer">
        <h4>Adquirente Atual</h4>
        <div class="acquirer-card active">
          <div class="acquirer-info">
            <i class="pi pi-building"></i>
            <span>{{ currentAcquirerName }}</span>
          </div>
          <span class="status-badge active">Ativo</span>
        </div>
      </div>

      <div class="available-acquirers">
        <h4>Adquirentes Disponíveis</h4>
        <div class="acquirers-grid">
          <div *ngFor="let acquirer of acquirerSettings.availableAcquirers" class="acquirer-card"
            [class.active]="acquirer.status === 'active'" (click)="changeAcquirer(acquirer.id)">
            <div class="acquirer-info">
              <i class="pi pi-building"></i>
              <span>{{ acquirer.name }}</span>
            </div>
            <span class="status-badge" [class.active]="acquirer.status === 'active'">
              {{ acquirer.status === 'active' ? 'Ativo' : 'Disponível' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="baasDialogVisible" title="Alterar BaaS" [actions]="[
      {id:'save', label:'Salvar', type:'primary'},
      {id:'close', label:'Cancelar', type:'text'}
    ]" (action)="handleBaasDialogAction($event)" width="700px">

    <div class="baas-content">
      <div class="current-baas">
        <h4>Provedor BaaS Atual</h4>
        <div class="baas-card active">
          <div class="baas-info">
            <i class="pi pi-server"></i>
            <span>{{ currentBaasProviderName }}</span>
          </div>
          <span class="status-badge active">Ativo</span>
        </div>
      </div>

      <div class="available-baas">
        <h4>Provedores Disponíveis</h4>
        <div class="baas-grid">
          <div *ngFor="let provider of baasSettings.availableProviders" class="baas-card"
            [class.active]="provider.status === 'active'" (click)="changeBaasProvider(provider.id)">
            <div class="baas-info">
              <i class="pi pi-server"></i>
              <span>{{ provider.name }}</span>
            </div>
            <span class="status-badge" [class.active]="provider.status === 'active'">
              {{ provider.status === 'active' ? 'Ativo' : 'Disponível' }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>

  <app-custom-dialog [(visible)]="subaccountDialogVisible" title="Visualizar Subconta" [actions]="[
      {id:'close', label:'Fechar', type:'text'}
    ]" (action)="handleSubaccountDialogAction($event)" width="800px">

    <div class="subaccount-content">
      <div class="account-info">
        <div class="account-header">
          <h4>Informações da Conta</h4>
          <span class="account-status active">Ativa</span>
        </div>

        <div class="account-details">
          <div class="detail-item">
            <span class="label">Número da Conta:</span>
            <span class="value">{{ subaccountData.accountNumber }}</span>
          </div>

          <div class="detail-item">
            <span class="label">Agência:</span>
            <span class="value">{{ subaccountData.agency }}</span>
          </div>

          <div class="detail-item">
            <span class="label">Saldo Atual:</span>
            <span class="value balance">{{ fmt(subaccountData.balance, 'currency') }}</span>
          </div>
        </div>
      </div>

      <div class="recent-transactions">
        <h4>Transações Recentes</h4>
        <div class="transactions-list">
          <div *ngFor="let transaction of subaccountData.transactions" class="transaction-item">
            <div class="transaction-info">
              <span class="transaction-date">{{ transaction.date | date:'dd/MM/yyyy HH:mm' }}</span>
              <span class="transaction-desc">{{ transaction.description }}</span>
            </div>
            <span class="transaction-amount" [class.credit]="transaction.type === 'credit'"
              [class.debit]="transaction.type === 'debit'">
              {{ transaction.type === 'credit' ? '+' : '' }}{{ fmt(transaction.amount, 'currency') }}
            </span>
          </div>
        </div>
      </div>
    </div>
  </app-custom-dialog>
</section>
